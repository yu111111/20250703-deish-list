### **Supabaseセットアップ手順書**

この手順書では、「We Wishlist」アプリケーションに必要なSupabaseプロジェクトの作成、データベーステーブルの定義、および行レベルセキュリティ（RLS）の設定方法を説明します。

#### 1. Supabaseプロジェクトの作成

1.  **Supabaseアカウントにログイン**:
    *   [Supabaseのウェブサイト](https://supabase.com/)にアクセスし、ログインします。アカウントがない場合は作成してください。
2.  **新しいプロジェクトの作成**:
    *   ダッシュボードで「New project」をクリックします。
3.  **プロジェクト詳細の入力**:
    *   **Name**: `we-wishlist` など、任意のプロジェクト名を入力します。
    *   **Organization**: 適切な組織を選択します。
    *   **Database Password**: 強力なパスワードを設定し、安全な場所に保管してください。
    *   **Region**: 最も近いリージョンを選択します（例: `Tokyo (ap-northeast-1)`）。
    *   **Pricing Plan**: 「Free」プランを選択します。
4.  **プロジェクトの作成**:
    *   「Create new project」をクリックします。プロジェクトのプロビジョニングには数分かかります。

#### 2. SQLスクリプトによるテーブルとRLSポリシーの作成

以下のSQL文をSupabaseダッシュボードの「SQL Editor」で実行してください。

**実行方法:**

1.  Supabaseダッシュボードにログインします。
2.  左側のナビゲーションバーから「SQL Editor」を選択します。
3.  以下のSQLスクリプトをコピーして、エディタに貼り付けます。
4.  `profiles`テーブルのSQLを先に実行し、成功したら`items`テーブルのSQLを実行してください。
5.  「RUN」ボタンをクリックしてSQLを実行します。

##### 2.1. `profiles` テーブルの作成とRLSポリシー

```sql
CREATE TABLE public.profiles (
    id uuid PRIMARY KEY DEFAULT auth.uid(),
    username text,
    list_id uuid DEFAULT auth.uid(),
    created_at timestamptz DEFAULT now()
);

-- RLSを有効にする
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;

-- RLSポリシーの作成 (profilesテーブル)
-- 読み取りアクセス
CREATE POLICY "Allow read access to all profiles"
ON public.profiles FOR SELECT USING (true);

-- 挿入アクセス (自身のプロフィールのみ)
CREATE POLICY "Allow authenticated users to insert their own profile"
ON public.profiles FOR INSERT WITH CHECK (auth.uid() = id);

-- 更新アクセス (自身のプロフィールのみ)
CREATE POLICY "Allow authenticated users to update their own profile"
ON public.profiles FOR UPDATE USING (auth.uid() = id);
```

##### 2.2. `items` テーブルの作成とRLSポリシー

```sql
CREATE TABLE public.items (
    id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    list_id uuid NOT NULL,
    author_id uuid NOT NULL DEFAULT auth.uid(),
    item_name text NOT NULL,
    price integer,
    is_completed boolean DEFAULT false,
    created_at timestamptz DEFAULT now()
);

-- RLSを有効にする
ALTER TABLE public.items ENABLE ROW LEVEL SECURITY;

-- 外部キー制約の追加
ALTER TABLE public.items
ADD CONSTRAINT fk_list_id
FOREIGN KEY (list_id) REFERENCES public.profiles(id);

ALTER TABLE public.items
ADD CONSTRAINT fk_author_id
FOREIGN KEY (author_id) REFERENCES public.profiles(id);

-- RLSポリシーの作成 (itemsテーブル)
-- 読み取りアクセス (自身のリスト内のアイテムのみ)
CREATE POLICY "Allow read access to items in user's list"
ON public.items FOR SELECT USING (list_id IN ( SELECT list_id FROM profiles WHERE id = auth.uid() ));

-- 挿入アクセス (自身のリストに自身のアイテムのみ)
CREATE POLICY "Allow authenticated users to insert items into their list"
ON public.items FOR INSERT WITH CHECK (list_id IN ( SELECT list_id FROM profiles WHERE id = auth.uid() ) AND author_id = auth.uid());

-- 更新アクセス (自身のリスト内のアイテムのみ)
CREATE POLICY "Allow authenticated users to update items in their list"
ON public.items FOR UPDATE USING (list_id IN ( SELECT list_id FROM profiles WHERE id = auth.uid() ));

-- 削除アクセス (自身のリスト内のアイテムのみ)
CREATE POLICY "Allow authenticated users to delete items from their list"
ON public.items FOR DELETE USING (list_id IN ( SELECT list_id FROM profiles WHERE id = auth.uid() ));
```

#### 3. 環境変数の確認

Supabaseダッシュボードの左側ナビゲーションから「Project Settings」→「API」を選択します。

*   **Project URL**: `https://your-project-ref.supabase.co` の形式のURL
*   **Project API keys**: `anon public` のキー

これらの値が、`script.js`の先頭に記述されている`SUPABASE_URL`と`SUPABASE_ANON_KEY`と一致していることを確認してください。もし異なる場合は、`script.js`を更新してください。